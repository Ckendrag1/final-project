from aiogram import Bot, Dispatcher, executor, types
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.contrib.fsm_storage.memory import MemoryStorage
import datetime
import asyncio
from config import token
from aiogram.types import Message
import sqlite3

conn = sqlite3.connect("diary.db")
cursor = conn.cursor()


# ---------- –°–û–°–¢–û–Ø–ù–ò–Ø ----------
class ReminderStates(StatesGroup):
    waiting_for_datetime = State()
    waiting_for_text = State()


# ---------- –ö–ê–¢–ï–ì–û–†–ò–ò ----------
CATEGORIES = {
    "–ó–∞–¥–∞—á–∞ üìå": ["—Å–¥–µ–ª–∞—Ç—å", "–Ω—É–∂–Ω–æ", "–∫—É–ø–∏—Ç—å", "–ø–ª–∞–Ω"],
    "–ó–¥–æ—Ä–æ–≤—å–µ üè•": ["–≤—Ä–∞—á", "–±–æ–ª–∏—Ç", "–∞–ø—Ç–µ–∫–∞", "—Ç–∞–±–ª–µ—Ç–∫–∏", "–±–æ–ª—å–Ω–∏—Ü–∞"],
    "–£—á—ë–±–∞ üìö": ["—É—Ä–æ–∫", "–¥–∑", "—ç–∫–∑–∞–º–µ–Ω", "—à–∫–æ–ª–∞"],
    "–†–∞–±–æ—Ç–∞ üíº": ["—Ä–∞–±–æ—Ç–∞", "–ø—Ä–æ–µ–∫—Ç", "–∫–ª–∏–µ–Ω—Ç"],
    "–õ–∏—á–Ω–æ–µ üí¨": ["–¥—Ä—É–≥", "—Å–µ–º—å—è", "–ª—é–±–ª—é"]
}

def detect_category(text: str) -> str:
    text = text.lower()
    for category, words in CATEGORIES.items():
        for w in words:
            if w in text:
                return category
    return "–ú—ã—Å–ª—å üí≠"

DAY_ALIASES = {
    "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
    "–≤—Ç–æ—Ä–Ω–∏–∫": "–í—Ç–æ—Ä–Ω–∏–∫",
    "—Å—Ä–µ–¥": "–°—Ä–µ–¥–∞",
    "—á–µ—Ç–≤–µ—Ä–≥": "–ß–µ—Ç–≤–µ—Ä–≥",
    "–ø—è—Ç–Ω–∏—Ü": "–ü—è—Ç–Ω–∏—Ü–∞",
    "—Å—É–±–±–æ—Ç": "–°—É–±–±–æ—Ç–∞",
    "–≤–æ—Å–∫—Ä–µ—Å": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
    "–∑–∞–≤—Ç—Ä–∞": "–ó–∞–≤—Ç—Ä–∞"
}

WEEK_DAYS = [
    "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞",
    "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
]

# –ú–∞–ø–ø–∏–Ω–≥ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –Ω–∞ —á–∏—Å–ª–∞ (0 = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6 = –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
DAY_TO_NUMBER = {
    "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": 0,
    "–≤—Ç–æ—Ä–Ω–∏–∫": 1,
    "—Å—Ä–µ–¥–∞": 2,
    "—á–µ—Ç–≤–µ—Ä–≥": 3,
    "–ø—è—Ç–Ω–∏—Ü–∞": 4,
    "—Å—É–±–±–æ—Ç–∞": 5,
    "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ": 6
}

def get_reminder_date_for_day(target_day: str) -> datetime.datetime:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–¥–µ–Ω—å –ø–µ—Ä–µ–¥ —Ü–µ–ª–µ–≤—ã–º –¥–Ω—ë–º –≤ 20:00)
    """
    target_day_lower = target_day.lower()
    
    if target_day_lower not in DAY_TO_NUMBER:
        return None
    
    target_weekday = DAY_TO_NUMBER[target_day_lower]
    today = datetime.date.today()
    current_weekday = today.weekday()
    
    # –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ —Ü–µ–ª–µ–≤–æ–≥–æ –¥–Ω—è
    days_until_target = (target_weekday - current_weekday) % 7
    
    # –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è, –±–µ—Ä—ë–º —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é
    if days_until_target == 0:
        days_until_target = 7
    
    target_date = today + datetime.timedelta(days=days_until_target)
    
    # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å –ø–µ—Ä–µ–¥ —Ü–µ–ª–µ–≤—ã–º –¥–Ω—ë–º –≤ 20:00
    reminder_date = target_date - datetime.timedelta(days=1)
    reminder_datetime = datetime.datetime.combine(reminder_date, datetime.time(20, 0))
    
    # –ï—Å–ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º, –Ω–µ —Å–æ–∑–¥–∞—ë–º –µ–≥–æ
    if reminder_datetime <= datetime.datetime.now():
        return None
    
    return reminder_datetime

def parse_week_task(text: str):
    text = text.lower()

    for key, day_name in DAY_ALIASES.items():
        if f"–¥–æ {key}" in text:
            task = text.split(f"–¥–æ {key}")[0].strip()
            if task:
                return day_name, task

    return None, None

# ---------- BOT ----------
BOT_TOKEN = token

storage = MemoryStorage()
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot, storage=storage)



cursor.execute("""
CREATE TABLE IF NOT EXISTS entries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    text TEXT,
    category TEXT,
    date TEXT
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS reminders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    text TEXT,
    remind_time TEXT
)
""")

cursor.execute("""
CREATE TABLE IF NOT EXISTS week_plan (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    day TEXT,
    task TEXT
)
""")
conn.commit()

# ---------- /start ----------
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    await message.answer(
        "üìî –£–º–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ + –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n\n"
        "üìù –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç ‚Äî —è —Å–æ—Ö—Ä–∞–Ω—é –∑–∞–ø–∏—Å—å\n"
        "üìñ /diary ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏\n"
        "üóë /delete ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –Ω–æ–º–µ—Ä—É\n"
        "üßπ /clear ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏\n"
        "‚è∞ /remind ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–ø–æ—à–∞–≥–æ–≤–æ)\n" 
        "üìã /reminder ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
        "/week - –ø–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é\n"
        "/weekadd - –¥–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é\n"
        "/weekclear - –æ—á–∏—Å—Ç–∏—Ç—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é\n\n"
        "üí° –ü–∏—à–∏ '—Å–¥–µ–ª–∞—Ç—å X –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞' ‚Äî —è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 20:00!\n\n"
        "üîπ –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: /remind 2026-01-20 15:00 —Ç–µ–∫—Å—Ç"
    )

# ---------- /weekadd ----------

DAYS = [
    "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–≤—Ç–æ—Ä–Ω–∏–∫", "—Å—Ä–µ–¥–∞",
    "—á–µ—Ç–≤–µ—Ä–≥", "–ø—è—Ç–Ω–∏—Ü–∞", "—Å—É–±–±–æ—Ç–∞", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
]

@dp.message_handler(commands=["weekadd"])
async def add_week_plan(message: types.Message):
    parts = message.text.split(maxsplit=2)

    if len(parts) < 3:
        await message.answer(
            "‚ùå –§–æ—Ä–º–∞—Ç:\n/weekadd –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∑–∞–¥–∞—á–∞"
        )
        return

    day = parts[1].lower()
    task = parts[2]

    if day not in DAYS:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏")
        return

    cursor.execute(
        "INSERT INTO week_plan (user_id, day, task) VALUES (?, ?, ?)",
        (message.from_user.id, day.capitalize(), task)
    )
    conn.commit()

    await message.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ:\n{day.capitalize()} ‚Äî {task}")

# ---------- /week ----------

@dp.message_handler(commands=["week"])
async def show_week_plan(message: types.Message):
    cursor.execute(
        "SELECT day, task FROM week_plan WHERE user_id = ?",
        (message.from_user.id,)
    )
    rows = cursor.fetchall()

    if not rows:
        await message.answer("üì≠ –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é –ø—É—Å—Ç")
        return

    unique = set()
    msg = "üìÖ –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é:\n\n"

    for day, task in rows:
        key = (day, task)
        if key not in unique:
            unique.add(key)
            msg += f"‚Ä¢ {day}: {task}\n"

    await message.answer(msg)


# ---------- /weekclear ----------

@dp.message_handler(commands=["weekclear"])
async def clear_week_plan(message: types.Message):
    cursor.execute(
        "DELETE FROM week_plan WHERE user_id = ?",
        (message.from_user.id,)
    )
    conn.commit()

    await message.answer("üßπ –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é –æ—á–∏—â–µ–Ω")


# ---------- –£–ú–ù–´–ô REMIND ----------
@dp.message_handler(commands=["remind"], state="*")
async def add_reminder(message: types.Message, state: FSMContext):
    args = message.text.split(maxsplit=1)
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã - —Å—Ç–∞—Ä—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±
    if len(args) > 1:
        try:
            parts = args[1].split()
            
            if "-" in parts[0]:
                date_part = parts[0]
                time_part = parts[1]
                text = " ".join(parts[2:])
            else:
                date_part = f"{parts[0]}-{parts[1]}-{parts[2]}"
                time_part = parts[3]
                text = " ".join(parts[4:])

            remind_dt = datetime.datetime.strptime(
                f"{date_part} {time_part}", "%Y-%m-%d %H:%M"
            )

            cursor.execute(
                "INSERT INTO reminders (user_id, text, remind_time) VALUES (?, ?, ?)",
                (
                    message.from_user.id,
                    text,
                    remind_dt.strftime("%Y-%m-%d %H:%M")
                )
            )
            conn.commit()

            await message.answer(
                f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ\nüìÖ {remind_dt.strftime('%Y-%m-%d %H:%M')}"
            )
            return

        except Exception as e:
            await message.answer(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "/remind 2026-01-20 15:00 –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É\n"
                "/remind 2026 01 20 15:00 –ó–∞–ø–∏—Å—å –∫ –≤—Ä–∞—á—É"
            )
            return
    
    # –ü–æ—à–∞–≥–æ–≤—ã–π —Ä–µ–∂–∏–º
    await state.finish()  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await ReminderStates.waiting_for_datetime.set()
    await message.answer(
        "üìÖ –ö–æ–≥–¥–∞ –Ω–∞–ø–æ–º–Ω–∏—Ç—å?\n\n"
        "–ù–∞–ø–∏—à–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "2026-01-20 15:00\n"
        "–∏–ª–∏\n"
        "2026 01 20 15:00"
    )


# ---------- –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–¢–´/–í–†–ï–ú–ï–ù–ò ----------
@dp.message_handler(state=ReminderStates.waiting_for_datetime)
async def get_datetime(message: types.Message, state: FSMContext):
    try:
        parts = message.text.split()
        
        if "-" in parts[0]:
            date_part = parts[0]
            time_part = parts[1]
        else:
            date_part = f"{parts[0]}-{parts[1]}-{parts[2]}"
            time_part = parts[3]
        
        remind_dt = datetime.datetime.strptime(
            f"{date_part} {time_part}", "%Y-%m-%d %H:%M"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.update_data(remind_time=remind_dt)
        
        await ReminderStates.waiting_for_text.set()
        await message.answer(
            f"‚úÖ –í—Ä–µ–º—è: {remind_dt.strftime('%Y-%m-%d %H:%M')}\n\n"
            "üìù –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:"
        )
        
    except Exception as e:
        await message.answer(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:\n"
            "2026-01-20 15:00"
        )


# ---------- –ü–û–õ–£–ß–ï–ù–ò–ï –¢–ï–ö–°–¢–ê ----------
@dp.message_handler(state=ReminderStates.waiting_for_text)
async def get_text(message: types.Message, state: FSMContext):
    data = await state.get_data()
    remind_dt = data['remind_time']
    
    cursor.execute(
        "INSERT INTO reminders (user_id, text, remind_time) VALUES (?, ?, ?)",
        (
            message.from_user.id,
            message.text,
            remind_dt.strftime("%Y-%m-%d %H:%M")
        )
    )
    conn.commit()
    
    await message.answer(
        f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!\n\n"
        f"üìÖ {remind_dt.strftime('%Y-%m-%d %H:%M')}\n"
        f"üìù {message.text}"
    )
    
    await state.finish()


# ---------- –ü–û–ö–ê–ó –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô ----------
@dp.message_handler(commands=["reminder"])
async def show_reminders(message: types.Message):
    cursor.execute(
        "SELECT text, remind_time FROM reminders WHERE user_id = ? ORDER BY remind_time",
        (message.from_user.id,)
    )
    rows = cursor.fetchall()

    if not rows:
        await message.answer("üì≠ –£ —Ç–µ–±—è –Ω–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
        return

    msg = "‚è∞ –¢–≤–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:\n\n"
    for i, (text, time) in enumerate(rows, start=1):
        msg += f"{i}. üìÖ {time}\nüìù {text}\n\n"

    await message.answer(msg)


# ---------- –ü–û–ö–ê–ó –ó–ê–ü–ò–°–ï–ô ----------
@dp.message_handler(commands=["diary"])
async def show_diary(message: types.Message):
    cursor.execute(
        "SELECT id, text, category, date FROM entries WHERE user_id = ? ORDER BY date DESC",
        (message.from_user.id,)
    )
    rows = cursor.fetchall()

    if not rows:
        await message.answer("üì≠ –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π")
        return

    msg = "üìî –¢–≤–æ–∏ –∑–∞–ø–∏—Å–∏:\n\n"
    for i, (entry_id, text, category, date) in enumerate(rows, start=1):
        msg += f"{i}. üìÖ {date}\n{category}\nüí¨ {text}\n\n"
    
    await message.answer(msg)


# ---------- –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò –ü–û –ù–û–ú–ï–†–£ ----------
@dp.message_handler(commands=["delete"])
async def delete_entry(message: types.Message):
    try:
        args = message.text.split()
        if len(args) < 2:
            await message.answer("‚ùå –£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏\n–ü—Ä–∏–º–µ—Ä: /delete 1")
            return
        
        number = int(args[1])
        
        cursor.execute(
            "SELECT id FROM entries WHERE user_id = ? ORDER BY date DESC",
            (message.from_user.id,)
        )
        rows = cursor.fetchall()
        
        if not rows:
            await message.answer("üì≠ –£ —Ç–µ–±—è –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π")
            return
        
        if number < 1 or number > len(rows):
            await message.answer(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä. –£ —Ç–µ–±—è {len(rows)} –∑–∞–ø–∏—Å–µ–π")
            return
        
        entry_id = rows[number - 1][0]
        
        cursor.execute("DELETE FROM entries WHERE id = ?", (entry_id,))
        conn.commit()
        
        await message.answer(f"üóë –ó–∞–ø–∏—Å—å #{number} —É–¥–∞–ª–µ–Ω–∞")
        
    except ValueError:
        await message.answer("‚ùå –£–∫–∞–∂–∏ —á–∏—Å–ª–æ\n–ü—Ä–∏–º–µ—Ä: /delete 1")


# ---------- –û–ß–ò–°–¢–ö–ê –í–°–ï–• –ó–ê–ü–ò–°–ï–ô ----------
@dp.message_handler(commands=["clear"])
async def clear_diary(message: types.Message):
    cursor.execute(
        "DELETE FROM entries WHERE user_id = ?",
        (message.from_user.id,)
    )
    conn.commit()
    
    await message.answer("üßπ –í—Å–µ –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã")


# ---------- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò ----------
@dp.message_handler()
async def handle_text(message: types.Message):
    day, task = parse_week_task(message.text)

    # --------- –ï–°–õ–ò –≠–¢–û –ü–õ–ê–ù –ù–ê –ù–ï–î–ï–õ–Æ ---------
    if day:
        cursor.execute(
            "SELECT 1 FROM week_plan WHERE user_id = ? AND day = ? AND task = ?",
            (message.from_user.id, day, task)
        )

        if cursor.fetchone():
            await message.answer("‚ö†Ô∏è –¢–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —É–∂–µ –µ—Å—Ç—å –≤ –ø–ª–∞–Ω–µ")
            return

        cursor.execute(
            "INSERT INTO week_plan (user_id, day, task) VALUES (?, ?, ?)",
            (message.from_user.id, day, task)
        )
        conn.commit()

        # --------- –°–û–ó–î–ê–Å–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï ---------
        reminder_datetime = get_reminder_date_for_day(day)
        
        response_msg = f"üìÖ –î–æ–±–∞–≤–∏–ª –≤ –ø–ª–∞–Ω:\n‚Ä¢ {day}: {task}"
        
        if reminder_datetime:
            cursor.execute(
                "INSERT INTO reminders (user_id, text, remind_time) VALUES (?, ?, ?)",
                (
                    message.from_user.id,
                    f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {task} (–¥–æ {day})",
                    reminder_datetime.strftime("%Y-%m-%d %H:%M")
                )
            )
            conn.commit()
            
            response_msg += f"\n\n‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∞ {reminder_datetime.strftime('%d.%m.%Y –≤ %H:%M')}"
        else:
            response_msg += "\n\n‚ö†Ô∏è –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ (–≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ)"

        await message.answer(response_msg)
        return

    # --------- –ò–ù–ê–ß–ï –≠–¢–û –û–ë–´–ß–ù–ê–Ø –ó–ê–ü–ò–°–¨ ---------
    category = detect_category(message.text)

    cursor.execute(
        "INSERT INTO entries (user_id, text, category, date) VALUES (?, ?, ?, ?)",
        (
            message.from_user.id,
            message.text,
            category,
            str(datetime.date.today())
        )
    )
    conn.commit()

    await message.answer(
        f"üìî –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞\nüß† –¢–∏–ø –∑–∞–ø–∏—Å–∏: {category}"
    )


# ---------- –ü–†–û–í–ï–†–ö–ê –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô ----------
async def reminder_checker():
    while True:
        now = datetime.datetime.now()

        cursor.execute("SELECT id, user_id, text, remind_time FROM reminders")
        rows = cursor.fetchall()

        for r_id, user_id, text, time_str in rows:
            remind_time = datetime.datetime.strptime(
                time_str, "%Y-%m-%d %H:%M"
            )

            if remind_time <= now:
                await bot.send_message(
                    user_id,
                    f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:\n{text}"
                )
                cursor.execute(
                    "DELETE FROM reminders WHERE id = ?",
                    (r_id,)
                )
                conn.commit()

        await asyncio.sleep(30)


# ---------- START ----------
async def on_startup(dp):
    asyncio.create_task(reminder_checker())

if __name__ == "__main__":
    executor.start_polling(dp, on_startup=on_startup)
